<div class="min-h-screen text-white flex w-full"
  style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); min-width: fit-content;">
  <app-sidebar></app-sidebar>
  <app-task-detail [task]="selectedTask" (taskUpdated)="onTaskUpdated($event)" [isHidden]="isDetailPanelHidden"
    [estadoNombre]="selectedTaskEstadoNombre" (closePanel)="hideTaskDetails()" [rolMiembro]="rolUsuario">
  </app-task-detail>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="flex-1 p-4 fade-slide-in">
    <!-- Filtro de vistas -->
    <div class="flex flex-wrap items-center gap-3 mb-6">

      <!-- Vista Kanban -->
      <button title="Cambiar a la vista Kanban" (click)="setViewMode('kanban')" [class]="viewMode === 'kanban' ?
            'bg-gray-700 text-white shadow-lg border border-gray-600' :
            'bg-gray-800/60 text-white hover:bg-gray-700/80 border border-gray-700'"
        class="px-4 py-3 rounded-xl transition-all duration-300 ease-out flex items-center gap-3 group relative overflow-hidden">
        <!-- Efecto de fondo sutil -->
        <div class="absolute inset-0 bg-green-500 opacity-0 group-hover:opacity-5 transition-opacity duration-300">
        </div>
        <!-- Icono -->
        <div class="relative z-10">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
          </svg>
        </div>
        <!-- Texto -->
        <span class="relative z-10 font-medium text-sm" style="color: white !important;">Kanban</span>

        <!-- Indicador activo sutil -->
        @if(viewMode === 'kanban') {
        <div class="absolute top-2 right-2 w-1.5 h-1.5 bg-green-400 rounded-full"></div>
        }
      </button>

      <!-- Vista Lista -->
      @if(!isMobile){
      <button title="Cambiar a la vista en forma de lista" (click)="setViewMode('list')" [class]="viewMode === 'list' ?
            'bg-gray-700 text-white   border-gray-600 ' :
            'bg-gray-800/60 text-white hover:bg-gray-700/80 border border-gray-700'"
        class="px-4 py-3 rounded-xl transition-all duration-300 ease-out flex items-center gap-3 group relative overflow-hidden">
        <div class="absolute inset-0 bg-green-600 opacity-0 group-hover:opacity-5 transition-opacity duration-300">
        </div>
        <div class="relative z-10">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 6h18M3 14h12M3 18h12" />
          </svg>
        </div>
        <span class="relative z-10 font-medium text-sm" style="color: white !important;">Lista</span>

        @if(viewMode === 'list') {
        <div class="absolute top-2 right-2 w-1.5 h-1.5 bg-green-400 rounded-full"></div>
        }
      </button>
      }

      <!-- Vista Tareas Asignadas - MEJORADO -->
      @if (!isMobile){
      <button title="Aquí puedes ver tus tareas asignadas" (click)="setViewMode('assigned')" [class]="viewMode === 'assigned' ?
            'bg-gray-700 text-white shadow-lg border border-gray-600' :
            'bg-gray-800/60 text-white hover:bg-gray-700/80 border border-gray-700'"
        class="px-4 py-3 rounded-xl transition-all duration-300 ease-out flex items-center gap-3 group relative overflow-hidden">
        <div class="absolute inset-0 bg-green-700 opacity-0 group-hover:opacity-5 transition-opacity duration-300">
        </div>
        <div class="relative z-10">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <span class="relative z-10 font-medium text-sm" style="color: white !important;">Mis Tareas</span>
        @if(viewMode === 'assigned') {
        <div class="absolute top-2 right-2 w-1.5 h-1.5 bg-green-400 rounded-full"></div>
        }
      </button>
      }

      <!-- Botón Google Calendar --->
      <button (click)="abrirCalendario()"
        class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-xl flex items-center gap-3 transition-all duration-300 border border-gray-600 hover:border-gray-500 group relative overflow-hidden">
        <div class="absolute inset-0 bg-green-600 opacity-0 group-hover:opacity-5 transition-opacity duration-300">
        </div>
        <i class="fas fa-calendar-alt relative z-10 text-sm"></i>
        <span class="relative z-10 font-medium text-sm" style="color: white !important;">Calendario</span>
      </button>

      <!-- Componente de calendario -->
      <app-calendario [tasks]="getTodasLasTareas()" (taskSynced)="onTareaSincronizada($event)"
        [isOpen]="calendarioAbierto" (isOpenChange)="calendarioAbierto = $event">
      </app-calendario>

      <!-- Botón de Acciones--->
      @if (puedeEditar() || puedeCrearColumnas() || puedeGestionarEtiquetas()) {
      <div class="relative inline-block text-left ml-auto">
        <button (click)="toggleMenu($event)"
          [class]="menuVisible ?
    'bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg border border-green-500' :
    'bg-gradient-to-r from-gray-700 to-gray-800 text-white hover:from-gray-600 hover:to-gray-700 border border-gray-600 shadow-md'"
          class="px-4 py-3 rounded-xl transition-all duration-300 flex items-center gap-3 relative overflow-hidden group"
          id="dropdownButton">

          <!-- Efecto de brillo en hover -->
          <div
            class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-300 rounded-xl">
          </div>

          <!-- Efecto de gradiente animado -->
          <div
            class="absolute inset-0 bg-gradient-to-r from-green-500/20 to-green-600/20 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-xl">
          </div>

          <!-- Icono mejorado -->
          <div class="relative z-10">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
          </div>

          <!-- Texto -->
          <span class="relative z-10 font-medium text-sm" style="color: white !important;">Acciones</span>


          <!-- Flecha indicadora mejorada -->
          <svg class="w-4 h-4 relative z-10 transition-transform duration-300" [class.rotate-180]="menuVisible"
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>

          <!-- Efecto de pulso cuando está activo -->
          @if (menuVisible) {
          <div class="absolute -inset-1 bg-green-400/20 rounded-xl animate-pulse"></div>
          }
        </button>

        <!-- Menú desplegable con más contraste -->
        @if (menuVisible) {
        <div
          class="absolute right-0 mt-2 w-72 rounded-xl shadow-2xl bg-gradient-to-b from-gray-800 to-gray-900 border border-gray-600 backdrop-blur-lg z-50 transform transition-all duration-300 scale-95 hover:scale-100"
          role="menu" aria-orientation="vertical" aria-labelledby="dropdownButton">

          <!-- Header del menú -->
          <div class="p-3 border-b border-gray-700">
            <h3 class="text-sm font-semibold text-white flex items-center gap-2">
              <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              Herramientas de Administración
            </h3>
          </div>

          <div class="p-2 space-y-2" role="none">
            <!-- Añadir Columna -->
            @if (puedeCrearColumnas()) {
            <button (click)="abrirModalNuevaColumna(); menuVisible = false"
              class="w-full px-4 py-3 text-left rounded-lg transition-all duration-200 flex items-center gap-3 hover:bg-gray-700/80 hover:transform hover:scale-[1.02] group relative overflow-hidden">
              <!-- Efecto de fondo en hover -->
              <div
                class="absolute inset-0 bg-green-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-lg">
              </div>

              <div class="p-2 bg-green-500/20 rounded-lg group-hover:bg-green-500/30 transition-colors relative z-10">
                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" stroke-width="1.5"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
              </div>
              <div class="flex-1 relative z-10">
                <div class="text-sm font-semibold text-white">Añadir Columna</div>
                <div class="text-xs text-gray-300">Nueva columna Kanban</div>
              </div>
              <div class="relative z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <svg class="w-4 h-4 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </button>
            }

            <!-- Añadir Etiqueta -->
            @if (puedeGestionarEtiquetas()) {
            <button (click)="modalEtiquetaVisible = true; menuVisible = false"
              class="w-full px-4 py-3 text-left rounded-lg transition-all duration-200 flex items-center gap-3 hover:bg-gray-700/80 hover:transform hover:scale-[1.02] group relative overflow-hidden">
              <div
                class="absolute inset-0 bg-green-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-lg">
              </div>

              <div class="p-2 bg-green-600/20 rounded-lg group-hover:bg-green-600/30 transition-colors relative z-10">
                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" stroke-width="1.5"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
              </div>
              <div class="flex-1 relative z-10">
                <div class="text-sm font-semibold text-white">Añadir Etiqueta</div>
                <div class="text-xs text-gray-300">Crear nueva etiqueta</div>
              </div>
              <div class="relative z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </button>

            <!-- Gestionar Etiquetas -->
            <button (click)="abrirPanelGestionEtiquetas(); menuVisible = false"
              class="w-full px-4 py-3 text-left rounded-lg transition-all duration-200 flex items-center gap-3 hover:bg-gray-700/80 hover:transform hover:scale-[1.02] group relative overflow-hidden">
              <div
                class="absolute inset-0 bg-red-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-lg">
              </div>

              <div class="p-2 bg-red-500/20 rounded-lg group-hover:bg-red-500/30 transition-colors relative z-10">
                <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" stroke-width="1.5"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </div>
              <div class="flex-1 relative z-10">
                <div class="text-sm font-semibold text-white">Gestionar Etiquetas</div>
                <div class="text-xs text-gray-300">Eliminar o editar etiquetas</div>
              </div>
              <div class="relative z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </button>
            }
          </div>

        </div>
        }
      </div>
      }
    </div>

    @if (modalConfirmEliminarVisible) {
    <div class="modal-overlay z-50 animate-fade-in">
      <div class="modal-content modal-box relative max-w-sm w-full p-6">
        <h3 class="text-lg font-semibold text-primary mb-4">Confirmar eliminación</h3>
        <p class="mb-4">
          ¿Estás seguro de que deseas eliminar la columna
          <strong>"{{ columnaAEliminarNombre }}"</strong>?<br />
          Esta acción no se puede deshacer.
        </p>
        <div class="flex justify-end gap-3">
          <button type="button" class="btn btn-outline btn-error" (click)="cerrarModalConfirmEliminar()">
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" (click)="confirmarEliminarColumna()">
            Eliminar
          </button>
        </div>
      </div>
    </div>
    }

    <!-- Vista Kanban -->
    @if (viewMode === 'kanban') {
    <div #kanbanContainer class="flex flex-col w-full gap-6 md:flex-row overflow-x-auto">
      @for (item of CategoriasK; track item.id) {
      <div
        class="w-full md:w-[300px] flex-shrink-0 rounded-lg shadow-md p-4 space-y-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700"
        [ngStyle]="getColumnColorClass(item.nombre)">
        <!-- Título y acciones -->
        <div class="flex items-center justify-between relative">
          <h2 class="text-lg font-semibold break-words max-w-full overflow-hidden"
            [ngStyle]="getTextColorClass(item.nombre)">
            {{ item.nombre }}
            <span
              class="ml-2 text-sm bg-gray-200 dark:bg-gray-800 rounded-full px-2 py-0.5 font-medium text-gray-600 dark:text-gray-400">
              {{ item.tasks.length }}
            </span>
          </h2>

          <!-- Botones de acciones de columna - Solo para administradores -->
          @if (puedeCambiarColores() || puedeEliminar()) {
          <div class="flex items-center space-x-2">
            <!-- Selector de color - Solo para administradores -->
            @if (puedeCambiarColores()) {
            <button (mousedown)="onToggleBtnDown($event, item.id)"
              class="color-toggle-btn p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700"
              aria-label="Cambiar color columna" title="Cambiar color columna">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-300" fill="none"
                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536M9 11l6 6H6v-3l6-6z" />
              </svg>
            </button>
            }

            <!-- Botón eliminar columna - Solo para administradores -->
            @if (puedeEliminar()) {
            <button (click)="abrirModalConfirmEliminar(item.id, item.nombre)"
              class="p-1 rounded hover:bg-red-100 dark:hover:bg-red-900" aria-label="Eliminar columna"
              title="Eliminar columna">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M6 7v13a2 2 0 002 2h8a2 2 0 002-2V7M9 7V4a2 2 0 012-2h2a2 2 0 012 2v3m5 0H4" />
              </svg>
            </button>
            }
          </div>
          } @if (colorSelectorVisible[item.id] && puedeCambiarColores()) {
          <div #colorSelectorContainer
            class="absolute right-0 top-full mt-2 bg-white dark:bg-gray-800 p-2 rounded shadow-md flex flex-wrap gap-2 z-10 border border-gray-300 dark:border-gray-700 max-w-[140px]"
            [attr.data-id]="item.id" (mousedown)="onPanelDown($event)">
            @for (color of colores; track color.id) {
            <button (click)="cambiarColorColumna(item.id, color)" [style.backgroundColor]="color.codigo"
              class="w-6 h-6 rounded cursor-pointer border border-gray-300 dark:border-gray-600 hover:border-gray-600 dark:hover:border-gray-400 transition"
              title="Seleccionar color" aria-label="Seleccionar color"></button>
            }
          </div>
          }
        </div>

        <!-- Línea horizontal separadora -->
        <hr class="border-gray-300 dark:border-gray-700 mb-4" />

        <!-- Lista de tareas con drag and drop -->
        <div cdkDropList [id]="item.id" [cdkDropListData]="item.tasks" [cdkDropListConnectedTo]="categoriasIds"
          (cdkDropListDropped)="drop($event)"
          class="space-y-3 min-h-[50px] max-h-[450px] overflow-y-auto rounded-lg p-1 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700"
          id="lista-tareas-{{ item.id }}">
          @for (A of item.tasks; track A.id) {
          <div cdkDrag [ngStyle]="getCardColorClass(item.nombre)"
            class="border-base-300 relative rounded-lg p-3 flex flex-col gap-2 border group hover:shadow-md hover:ring hover:ring-primary transition-colors cursor-pointer"
            [class.ring]="hoveredTaskId === A.id.toString()" [class.ring-primary]="hoveredTaskId === A.id.toString()"
            [class.ring-offset-2]="hoveredTaskId === A.id.toString()" (cdkDragStarted)="onDragStarted()"
            (cdkDragEnded)="onDragEnded()" (mouseenter)="onTaskHover(A.id.toString())"
            (mouseleave)="onTaskHoverLeave(A.id.toString())" (click)="showTaskDetails(A, item)">
            <!-- Título -->
            <span class="font-medium text-sm text-base-content break-words max-w-full">
              {{ A.title ?? '' }}
            </span>

            <!-- Responsables -->
            <span class="text-xs text-gray-600 dark:text-gray-400">
              {{ getNombreResponsables(A.assignee ?? []) }}
            </span>

            <!-- Fecha límite -->
            @if (A.dueDate) {
            <span class="text-xs font-semibold" [ngClass]="{
              'text-red-600': isOverdue(A.dueDate),
              'text-orange-600': isDueSoon(A.dueDate),
              'text-gray-500': !isOverdue(A.dueDate) && !isDueSoon(A.dueDate)
            }">
              {{ formatDate(A.dueDate) }}
            </span>
            }

            <!-- Breve descripción -->
            @if (A.bloquesContenido && A.bloquesContenido.length > 0) {
            <p class="text-xs line-clamp-2 text-gray-700 dark:text-gray-300">
              {{ A.bloquesContenido[0]?.text || '' }}
            </p>
            }

            <!-- Etiquetas -->
            @if (A.etiquetas && A.etiquetas.length > 0) {
            <div class="flex flex-wrap gap-1 mt-1">
              @for (nombreEtiqueta of getNombresEtiquetas(A.etiquetas); track nombreEtiqueta) {
              <span class="badge" [style.backgroundColor]="getEtiquetaColor(nombreEtiqueta)">
                {{ nombreEtiqueta }}
              </span>
              }
            </div>
            }

            <!-- Botones Edición y Eliminación visibles al hacer hover - Solo con permisos -->
            @if (hoveredTaskId === A.id.toString() && (puedeEditar() || puedeEliminar())) {
            <div class="absolute bottom-0 left-0 w-full flex justify-end gap-2 p-2">
              <!-- Botón editar - Solo para editores y administradores -->
              @if (puedeEditar()) {
              <button #botonEditarTarea
                class="p-2 rounded-full bg-opacity-60 bg-gray-800 text-white hover:bg-opacity-80 hover:bg-green-600 transition-opacity duration-200 ease-in-out"
                (click)="editarTarea(A.id); $event.stopPropagation()" aria-label="Editar tarea"
                style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="h-5 w-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M13.125 6.375l4.5 4.5m0 0l-7.5 7.5h-4.5v-4.5l7.5-7.5m0 0l2.25-2.25a1.125 1.125 0 0 1 1.594 1.594L13.125 6.375z" />
                </svg>
              </button>
              }

              <!-- Botón eliminar - Solo para administradores -->
              @if (puedeEliminar()) {
              <button
                class="p-2 rounded-full bg-opacity-60 bg-gray-800 text-white hover:bg-opacity-80 hover:bg-red-600 transition-opacity duration-200 ease-in-out"
                (click)="eliminarTarea(A.id)" aria-label="Eliminar tarea"
                style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15)" (click)="$event.stopPropagation()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="h-5 w-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
              </button>
              }
            </div>
            }
          </div>
          }
        </div>

        <!-- Botón Nueva Tarea - Solo para editores y administradores -->
        @if (puedeEditar()) {
        <button class="btn btn-sm w-full font-medium transition hover:scale-105 mt-3"
          [ngStyle]="getButtonColorClass(item.nombre)" (click)="abrirModal(item)"
          aria-label="Agregar nueva tarea a la columna {{ item.nombre }}">
          + Nueva Tarea
        </button>
        }
      </div>
      }

      <!-- Botón Añadir Columna - Solo para administradores -->
      @if (puedeCrearColumnas()) {
      <button
        class="w-full md:w-[300px] h-[80px] flex-shrink-0 rounded-lg border-2 border-dashed border-green-700 text-green-700 font-semibold flex items-center justify-center cursor-pointer transition hover:bg-green-800 hover:text-white"
        (click)="abrirModalNuevaColumna()" aria-label="Agregar nueva columna Kanban">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" fill="none" stroke="currentColor" stroke-width="2"
          viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 4v16m8-8H4" />
        </svg>
        Añadir columna
      </button>
      }
    </div>
    }

    <!-- VISTA LISTA -->
    @if (viewMode === 'list') {
    <div #listContainer class="flex flex-col w-full gap-6 animate-fadeIn transition-opacity duration-500 ease-in-out">
      <!-- Barra filtros -->
      <div class="mb-4 flex items-center gap-4">
        <div class="relative">
          <button (click)="mostrarPanelFiltros = !mostrarPanelFiltros" [attr.aria-pressed]="mostrarPanelFiltros"
            class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center gap-3 transition duration-300 text-sm border border-gray-600"
            aria-label="Mostrar filtros" type="button">
            <!-- Icono menú -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            Filtros @if (contadorFiltros > 0) {
            <span class="ml-3 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full select-none"
              aria-live="polite" aria-atomic="true">
              {{ contadorFiltros }}
            </span>
            }
          </button>

          <!-- Panel filtros -->
          @if (mostrarPanelFiltros) {
          <div class="mt-4 flex flex-col gap-6 relative">
            <!-- Buscador y listado filtros -->
            <div class="flex items-center gap-4">
              <!-- Campo de búsqueda -->
              <input *ngIf="mostrarPanelFiltros" type="text" [(ngModel)]="filtroTitulo"
                class="input input-bordered w-full sm:w-80 bg-gray-800 text-white text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200 border border-gray-600"
                placeholder="Buscar por título" />

              <div class="flex gap-2">
                <!-- Botón + Filtros -->
                <button (click)="mostrarListadoFiltros = !mostrarListadoFiltros"
                  class="btn btn-xs bg-gray-700 text-white hover:bg-gray-600 active:bg-gray-500 rounded-lg focus:ring-2 focus:ring-green-500 transition duration-200 border border-gray-600">
                  + Filtros
                </button>
              </div>
            </div>

            <!-- Filtros desplegables -->
            @if (mostrarListadoFiltros) {
            <div
              class="absolute w-64 max-h-60 overflow-y-auto bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 mt-2 left-1/2 transform -translate-x-1/2"
              (click)="$event.stopPropagation()">
              <input type="text" [(ngModel)]="textoFiltro"
                class="input input-bordered w-full rounded-t-lg bg-gray-700 text-white text-sm border-gray-600"
                placeholder="Buscar filtro..." />
              <ul class="text-sm max-h-40 overflow-auto">
                <!-- Filtros dinámicos -->
                @if (!filtrosSeleccionados.includes('responsable') && (!textoFiltro ||
                'responsable'.includes(textoFiltro))) {
                <li>
                  <button (click)="agregarFiltro('responsable')"
                    class="w-full text-left px-4 py-2 hover:bg-gray-700 transition duration-200">
                    Responsable
                  </button>
                </li>
                } @if (!filtrosSeleccionados.includes('categoria') && (!textoFiltro ||
                'categoria'.includes(textoFiltro))) {
                <li>
                  <button (click)="agregarFiltro('categoria')"
                    class="w-full text-left px-4 py-2 hover:bg-gray-700 transition duration-200">
                    Categoría
                  </button>
                </li>
                } @if (!filtrosSeleccionados.includes('etiquetas') && (!textoFiltro ||
                'etiquetas'.includes(textoFiltro))) {
                <li>
                  <button (click)="agregarFiltro('etiquetas')"
                    class="w-full text-left px-4 py-2 hover:bg-gray-700 transition duration-200">
                    Etiquetas
                  </button>
                </li>
                } @if (filtrosSeleccionados.length >= 3 || (textoFiltro &&
                !'responsablecategoriaetiquetas'.includes(textoFiltro))) {
                <li class="px-4 py-3 text-center text-gray-400">Sin filtros disponibles</li>
                }
              </ul>
            </div>
            }

            <!-- Botones de filtros seleccionados -->
            <div class="flex flex-wrap gap-3">
              @for (filtro of filtrosSeleccionados; track filtro) {
              <div class="relative">
                <button (click)="toggleTarjetaFiltro(filtro)"
                  class="btn btn-sm bg-gray-700 text-white text-xs flex items-center gap-2 border border-gray-600 hover:bg-gray-600">
                  {{ filtro | titlecase }}
                  <span class="ml-2 bg-red-500 text-white text-[10px] font-bold px-1 rounded"
                    *ngIf="getContadorFiltro(filtro) > 0">
                    {{ getContadorFiltro(filtro) }}
                  </span>

                  <svg (click)="quitarFiltro(filtro); $event.stopPropagation()" xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 ml-2 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>

                @if (filtroActivo === filtro) {

                <div #tarjetaFiltro
                  class="absolute z-40 mt-2 w-72 p-4 bg-gray-800 rounded-lg border border-gray-700 shadow-xl"
                  (click)="$event.stopPropagation()">
                  <input type="text" placeholder="Buscar {{ filtro }}" [(ngModel)]="buscadorFiltros[filtro]"
                    class="input input-bordered w-full mb-3 bg-gray-700 text-white text-sm border-gray-600" />

                  <!-- Selector de modo incluir/excluir -->
                  <div class="mb-3 text-xs text-gray-300 flex items-center gap-2">
                    <span class="font-medium">Modo:</span>
                    <button class="btn btn-xs bg-gray-700 hover:bg-gray-600 text-white border border-gray-600" (click)="
                      filtroModo[filtro] =
                        filtroModo[filtro] === 'incluir' ? 'excluir' : 'incluir'
                    ">
                      {{ filtroModo[filtro] === 'incluir' ? 'Incluir' : 'Excluir' }}
                    </button>
                  </div>

                  <ul class="max-h-48 overflow-auto text-sm text-white">
                    <!-- Filtro Responsable -->
                    @if (filtro === 'responsable') { @if (responsablesFiltrados.length > 0) { @for
                    (r of responsablesFiltrados; track r.usuario.id) {
                    <li
                      class="py-2 px-3 hover:bg-gray-700 cursor-pointer rounded-lg flex justify-between items-center transition duration-200 ease-in-out"
                      (click)="seleccionarResponsable(r)">
                      <label class="flex items-center gap-2 w-full cursor-pointer">
                        <input type="checkbox" [checked]="filtroResponsable.includes(r.usuario.id)"
                          (change)="seleccionarResponsable(r)"
                          class="cursor-pointer rounded border-gray-600 bg-gray-800 hover:bg-gray-700 focus:ring-2 focus:ring-green-500" />
                        <span class="text-gray-200">{{ r.usuario.nombre }} {{ r.usuario.apellido }}</span>
                      </label>
                    </li>
                    } } @else {
                    <li class="py-3 px-3 text-gray-400 text-sm italic">
                      Sin responsables disponibles
                    </li>
                    } }

                    <!-- Filtro Categoría -->
                    @if (filtro === 'categoria') { @if (categoriasFiltradas.length > 0) { @for (c of
                    categoriasFiltradas; track c.id) {
                    <li
                      class="py-2 px-3 hover:bg-gray-700 cursor-pointer rounded-lg flex justify-between items-center transition duration-200 ease-in-out">
                      <label class="flex items-center gap-2 w-full cursor-pointer">
                        <input type="checkbox" [checked]="filtroCategoria.includes(c.id)"
                          (change)="seleccionarCategoria(c.id)"
                          class="cursor-pointer rounded border-gray-600 bg-gray-800 hover:bg-gray-700 focus:ring-2 focus:ring-green-500" />
                        <span class="text-gray-200">{{ c.nombre }}</span>
                      </label>
                    </li>
                    } } @else {
                    <li class="py-3 px-3 text-gray-400 text-sm italic">
                      Sin categorías disponibles
                    </li>
                    } }

                    <!-- Filtro Etiquetas -->
                    @if (filtro === 'etiquetas') { @if (etiquetasFiltradas.length > 0) { @for (e of
                    etiquetasFiltradas; track e.id) {
                    <li
                      class="py-2 px-3 hover:bg-gray-700 cursor-pointer rounded-lg flex justify-between items-center transition duration-200 ease-in-out">
                      <label class="flex items-center gap-2 w-full cursor-pointer">
                        <input type="checkbox" [checked]="filtroEtiquetas.includes(e.id)"
                          (change)="toggleEtiqueta(e.id)" (click)="$event.stopPropagation()"
                          class="cursor-pointer rounded border-gray-600 bg-gray-800 hover:bg-gray-700 focus:ring-2 focus:ring-green-500" />
                        <span class="text-gray-200">{{ e.nombre }}</span>
                      </label>
                    </li>
                    } } @else {
                    <li class="py-3 px-3 text-gray-400 text-sm italic">
                      Sin etiquetas disponibles
                    </li>
                    } }
                  </ul>
                </div>
                }
              </div>

              }
            </div>
          </div>
          }
        </div>
        <!-- Botón Limpiar Filtros (pequeño) -->
        @if (contadorFiltros > 0) {
        <button (click)="limpiarFiltros()"
          class="ml-auto bg-red-600 text-white px-3 py-1 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 border border-red-500"
          aria-label="Limpiar todos los filtros" type="button">
          Limpiar filtros
        </button>
        }
      </div>

      <!-- Tabla tareas -->
      <div class="w-full overflow-x-auto rounded-xl shadow-md border border-gray-700 bg-gray-800">
        <div class="overflow-y-auto max-h-screen">
          <!-- Agregar scroll vertical con max-height -->
          <table class="table table-zebra bg-gray-800 rounded-xl text-sm animate-fadeIn">
            <thead class="bg-gray-700 text-white text-xs uppercase select-none">
              <tr>
                <th class="px-4 py-3 text-left resize-x overflow-auto min-w-[120px]">Título</th>
                <th class="px-4 py-3 text-left resize-x overflow-auto min-w-[160px]">
                  Responsables
                </th>
                <th class="px-4 py-3 text-left resize-x overflow-auto min-w-[100px]">Etiquetas</th>
                <th class="px-4 py-3 text-left resize-x overflow-auto min-w-[120px]">Fecha</th>
                <th class="px-4 py-3 text-left resize-x overflow-auto min-w-[160px]">Categoría</th>
                <!-- Columna acciones solo para usuarios con permisos -->
                @if (puedeEditar() || puedeEliminar()) {
                <th class="px-4 py-3 text-left resize-x overflow-auto min-w-[40px]">Acciones</th>
                }
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
              @for (item of tareasFiltradas; track item.tarea) {
              <tr
                class="hover:bg-gray-700/50 transition-colors duration-200 ease-in-out cursor-pointer @if (item.categoria === 'Sin empezar') { 'bg-gray-700' } @else if (item.categoria === 'En progreso') { 'bg-green-900/30' } @else if (item.categoria === 'Completada') { 'bg-green-900/30' } else { 'bg-gray-800' }">
                <td class="px-4 py-3 font-medium truncate max-w-[200px] text-white" title="{{ item.tarea.title }}">
                  {{ item.tarea.title }}
                </td>

                <!-- Columna Responsables -->
                <td class="px-4 py-3 truncate max-w-[200px] text-gray-300"
                  title="{{ getNombreResponsables(item.tarea.assignee) }}">
                  @if (item.tarea.assignee && item.tarea.assignee.length > 0) {
                  <span class="text-sm">
                    {{ getNombreResponsables(item.tarea.assignee) }}
                  </span>
                  } @else {
                  <span class="text-sm text-gray-400 italic flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                      stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M15 12H9m6-6a6 6 0 11-12 0 6 6 0 0112 0zM21 12a9 9 0 10-18 0 9 9 0 0018 0z" />
                    </svg>
                    Sin responsables
                  </span>
                  }
                </td>

                <!-- Columna Etiquetas -->
                <td class="px-4 py-3" title="Etiquetas">
                  @if (item.tarea.etiquetas && item.tarea.etiquetas.length > 0) {
                  <div class="flex flex-wrap gap-2">
                    @for (etiqueta of getNombresEtiquetas(item.tarea.etiquetas); track etiqueta) {
                    <span class="badge py-1 px-3 rounded-full text-xs font-semibold bg-gray-700 text-white">
                      {{ etiqueta }}
                    </span>
                    }
                  </div>
                  } @else {
                  <div class="text-gray-400 italic">Sin etiquetas</div>
                  }
                </td>

                <!-- Columna Fecha -->
                <td class="px-4 py-3 truncate max-w-[120px] text-gray-300" title="{{
                  item.tarea.dueDate
                    ? (item.tarea.dueDate | date : 'dd/MM/yyyy')
                    : 'Sin fecha límite'
                }}">
                  @if (!item.tarea.dueDate) {
                  <span class="text-gray-400 italic">Sin fecha límite</span>
                  } @else {
                  {{ item.tarea.dueDate | date : 'dd/MM/yyyy' }}
                  }
                </td>

                <!-- Columna Categoría -->
                <td class="px-4 py-3 text-sm font-medium text-white truncate max-w-[150px]"
                  title="{{ item.categoria }}">
                  {{ item.categoria }}
                </td>

                <!-- Columna Acciones - Solo para usuarios con permisos -->
                @if (puedeEditar() || puedeEliminar()) {
                <td class="px-4 py-3 flex justify-center gap-2">
                  <!-- Botón editar - Solo para editores y administradores -->
                  @if (puedeEditar()) {
                  <button
                    class="p-2 rounded-full bg-opacity-60 bg-gray-700 text-white hover:bg-opacity-80 hover:bg-green-600 transition-opacity duration-200 ease-in-out shadow-md border border-gray-600"
                    (click)="editarTarea(item.tarea.id)" aria-label="Editar tarea" type="button">
                    <!-- ícono lápiz -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                      stroke="currentColor" class="h-5 w-5">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M13.125 6.375l4.5 4.5m0 0l-7.5 7.5h-4.5v-4.5l7.5-7.5" />
                    </svg>
                  </button>
                  }

                  <!-- Botón eliminar - Solo para administradores -->
                  @if (puedeEliminar()) {
                  <button
                    class="p-2 rounded-full bg-opacity-60 bg-gray-700 text-white hover:bg-opacity-80 hover:bg-red-600 transition-opacity duration-200 ease-in-out shadow-md border border-gray-600"
                    (click)="eliminarTarea(item.tarea.id)" aria-label="Eliminar tarea" type="button">
                    <!-- ícono basurero -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                      stroke="currentColor" class="h-5 w-5">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                  </button>
                  }
                </td>
                }
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
    }

    <!-- VISTA TAREAS ASIGNADAS  -->
    @if (viewMode === 'assigned') {
    <div #assignedContainer
      class="flex flex-col w-full gap-6 animate-fadeIn transition-opacity duration-500 ease-in-out">
      <!-- Tabla de tareas -->
      <div class="w-full overflow-x-auto rounded-xl shadow border border-gray-700 bg-gray-800">
        <table class="table table-zebra bg-gray-800 rounded-xl text-sm animate-fadeIn">
          <thead class="bg-gray-700 text-white text-xs uppercase select-none">
            <tr>
              <th class="px-6 py-3 text-left resize-x overflow-auto min-w-[120px]">Título</th>
              <th class="px-6 py-3 text-left resize-x overflow-auto min-w-[160px]">Responsables</th>
              <th class="px-6 py-3 text-left resize-x overflow-auto min-w-[100px]">Etiquetas</th>
              <th class="px-6 py-3 text-left resize-x overflow-auto min-w-[120px]">Fecha</th>
              <th class="px-6 py-3 text-left resize-x overflow-auto min-w-[160px]">Categoría</th>
              <!-- Columna acciones solo para usuarios con permisos -->
              @if (puedeEditar() || puedeEliminar()) {
              <th class="px-6 py-3 text-left resize-x overflow-auto min-w-[160px]">Acciones</th>
              }
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-700 text-sm">
            @for (item of tareasAsignadasFiltradas; track item.tarea.id) {
            <tr class="hover:bg-gray-700/50 transition duration-200 ease-in-out">
              <!-- Columna Título -->
              <td class="px-6 py-3 font-medium truncate text-white">{{ item.tarea.title }}</td>

              <!-- Columna Responsables -->
              <td class="px-6 py-3 text-gray-300">
                @if (item.tarea.assignee && item.tarea.assignee.length > 0) {
                <span class="text-sm">
                  {{ getNombreResponsables(item.tarea.assignee) }}
                </span>
                } @else {
                <span class="text-sm text-gray-400 italic flex items-center gap-1">

                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M15 12H9m6-6a6 6 0 11-12 0 6 6 0 0112 0zM21 12a9 9 0 10-18 0 9 9 0 0018 0z" />
                  </svg>
                  Sin responsables
                </span>
                }
              </td>

              <!-- Columna Etiquetas -->
              <td class="px-6 py-3 text-gray-300">
                @if (item.tarea.etiquetas && item.tarea.etiquetas.length > 0) {
                <div>
                  @for (etiqueta of getNombresEtiquetas(item.tarea.etiquetas); track etiqueta) {
                  <span>
                    {{ etiqueta }}
                  </span>
                  }
                </div>
                } @else {
                <div class="text-gray-400 italic">Sin etiquetas</div>
                }
              </td>

              <!-- Columna Prioridad -->
              <td class="px-6 py-3 whitespace-nowrap text-gray-300">
                {{ item.tarea.dueDate | date : 'dd/MM/yyyy' }}
              </td>

              <!-- Columna Categoría -->
              <td class="px-6 py-3 text-sm font-medium text-white">
                {{ item.categoria }}
              </td>

              <!-- Columna Acciones - Solo para usuarios con permisos -->
              @if (puedeEditar() || puedeEliminar()) {
              <td>
                <!-- Contenedor de botones (editar y eliminar) -->
                <div class="flex gap-2">
                  <!-- Botón editar tarea - Solo para editores y administradores -->
                  @if (puedeEditar()) {
                  <button
                    class="p-2 rounded-full bg-opacity-60 bg-gray-700 text-white hover:bg-opacity-80 hover:bg-green-600 transition-opacity duration-200 ease-in-out border border-gray-600"
                    (click)="editarTarea(item.tarea.id)" aria-label="Editar tarea"
                    style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                      stroke="currentColor" class="h-5 w-5">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="M13.125 6.375l4.5 4.5m0 0l-7.5 7.5h-4.5v-4.5l7.5-7.5m0 0l2.25-2.25a1.125 1.125 0 0 1 1.594 1.594L13.125 6.375z" />
                    </svg>
                  </button>
                  }

                  <!-- Botón eliminar tarea- Solo para administradores -->
                  @if (puedeEliminar()) {
                  <button
                    class="p-2 rounded-full bg-opacity-60 bg-gray-700 text-white hover:bg-opacity-80 hover:bg-red-600 transition-opacity duration-200 ease-in-out border border-gray-600"
                    (click)="eliminarTarea(item.tarea.id)" aria-label="Eliminar tarea"
                    style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                      stroke="currentColor" class="h-5 w-5">
                      <path stroke-linecap="round" stroke-linejoin="round"
                        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                  </button>
                  }
                </div>
              </td>
              }
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
    }
  </main>

  <!-- Modal Nueva Tarea - Solo para editores y administradores -->
  @if (puedeEditar()) {
  <dialog id="modalNuevaTarea" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
    [open]="modalVisible">
    <form method="dialog" (submit)="crearTarea($event)"
      class="modal-box max-w-lg w-full p-6 bg-base-100 rounded-lg shadow-lg">
      <h3 class="font-bold text-lg mb-4">Crear Nueva Tarea</h3>

      <div class="mb-4">
        <label class="label mb-1">
          <span class="label-text font-semibold">Título *</span>
        </label>
        <input type="text" placeholder="Ej: Redactar propuesta comercial" [(ngModel)]="newTask.titulo" name="titulo"
          class="input input-bordered w-full" [ngClass]="{ 'border-red-500 focus:ring-red-400': errores.titulo }"
          required autocomplete="off" (input)="clearTituloError()" />

        @if(errores.titulo){
        <div class="text-red-500 text-xs mt-1 pl-1 flex items-center gap-1" aria-live="polite">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" class="inline-block mr-1" aria-hidden="true">
            <circle cx="12" cy="12" r="12" fill="#F87171" />
            <path d="M12 7v5M12 16h.01" stroke="#FFF" stroke-width="2" stroke-linecap="round" />
          </svg>
          El título es obligatorio
        </div>
        }
      </div>

      <!-- Fecha límite -->
      <label class="label">
        <span class="label-text font-semibold">Fecha límite</span>
      </label>
      <input type="date" [(ngModel)]="newTask.fechaLimite" name="fechaLimite"
        class="input input-bordered w-full mb-4" />

      <!-- Responsables -->
      <label class="label">
        <span class="label-text font-semibold">Responsables</span>
      </label>
      <div class="relative mb-4">
        <!-- Buscador de responsables -->
        <div class="mb-2">
          <input type="text" [(ngModel)]="busquedaResponsableNueva" placeholder="Buscar responsable..."
            name="busquedaResponsableNueva" class="input input-sm input-bordered w-full" />
        </div>
        <!-- Lista filtrada -->
        <ul class="max-h-40 overflow-y-auto">
          @for (miembro of filtrarResponsablesNueva(); track miembro.usuario.id) {
          <li>
            <label>
              <input type="checkbox" [checked]="newTask.responsablesIds.includes(miembro.usuario.id)"
                (change)="selectResponsable(miembro.usuario.id, $event)" />
              {{ miembro.usuario.nombre }} {{ miembro.usuario.apellido }}
            </label>
          </li>
          }
        </ul>
      </div>

      <!-- Etiquetas -->
      <label class="label">
        <span class="label-text font-semibold">Etiquetas</span>
      </label>
      <div class="relative mb-4">
        <!-- Buscador de etiquetas -->
        <div class="mb-2">
          <input type="text" [(ngModel)]="busquedaEtiquetaNueva" placeholder="Buscar etiqueta..."
            name="busquedaEtiquetaNueva" class="input input-sm input-bordered w-full" />
        </div>
        <!-- Lista filtrada -->
        <ul class="max-h-40 overflow-y-auto">
          @for (etiqueta of filtrarEtiquetasNueva(); track etiqueta.id) {
          <li>
            <label>
              <input type="checkbox" [checked]="newTask.etiquetaIds.includes(etiqueta.id)"
                (change)="selectEtiqueta(etiqueta.id, $event)" />
              {{ etiqueta.nombre }}
            </label>
          </li>
          }
        </ul>
      </div>

      <!-- Acciones -->
      <div class="modal-action flex justify-end gap-3 mt-6">
        <button type="button" (click)="cerrarModal()" class="btn btn-outline btn-error">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary">Crear</button>
      </div>
    </form>
  </dialog>

  }

  <!-- Modal Nueva Columna Kanban - Solo para administradores -->
  @if (puedeCrearColumnas()) {
  <dialog id="modalNuevaColumna" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
    [open]="modalColumnaVisible">
    <form method="dialog" (submit)="crearColumna($event)"
      class="modal-box max-w-md w-full p-6 bg-base-100 rounded-lg shadow-lg" autocomplete="off">
      <h3 class="font-bold text-lg mb-4">Crear Nueva Columna</h3>

      <!-- Nombre de la columna -->
      <label class="label">
        <span class="label-text font-semibold">Nombre *</span>
      </label>
      <input type="text" placeholder="Ej: En revisión" [(ngModel)]="nuevaColumnaNombre" name="nombreColumna"
        class="input input-bordered w-full mb-2" maxlength="36" required autofocus (input)="validarNombreColumna()" />
      @if(nuevaColumnaError){
      <div class="text-error text-base font-medium mb-3 flex items-center gap-2 pl-1">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="12" fill="#F87171" />
          <path d="M12 7v5M12 16h.01" stroke="#FFF" stroke-width="2" stroke-linecap="round" />
        </svg>
        {{ nuevaColumnaError }}
      </div>
      }

      <!-- Selección de color -->
      <label class="label">
        <span class="label-text font-semibold">Color *</span>
      </label>
      <div class="flex gap-2 flex-wrap mb-4">
        @for (color of colores; track color.id) {
        <button type="button" (click)="nuevaColumnaColorId = color.id" [style.backgroundColor]="color.codigo"
          class="w-7 h-7 rounded-full border border-gray-400 focus:outline-none"
          [class.ring]="nuevaColumnaColorId === color.id" aria-label="Seleccionar color">
          @if (nuevaColumnaColorId === color.id) {
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto my-auto h-3 w-3 text-white" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
          </svg>
          }
        </button>
        }
      </div>
      @if (!nuevaColumnaColorId) {
      <div class="text-error text-sm font-medium mb-2 pl-1 flex items-center gap-1">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="12" fill="#F87171" />
          <path d="M12 7v5M12 16h.01" stroke="#FFF" stroke-width="2" stroke-linecap="round" />
        </svg>
        Elige un color para la columna
      </div>
      }

      <!-- Acciones -->
      <div class="modal-action flex justify-end gap-3 mt-6">
        <button type="button" (click)="cerrarModalNuevaColumna()" class="btn btn-outline btn-error">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!nuevaColumnaNombre.trim() || !nuevaColumnaColorId">
          Crear
        </button>
      </div>
    </form>
  </dialog>
  }

  <!-- Modal Confirmar Eliminar Columna - Solo para administradores -->
  @if (puedeEliminar()) {
  <dialog id="modalConfirmEliminarColumna"
    class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
    [open]="modalConfirmEliminarVisible">
    <form method="dialog" (submit)="confirmarEliminarColumna()"
      class="modal-box max-w-md w-full p-6 bg-base-100 rounded-lg shadow-lg">
      <!-- Título del Modal -->
      <h3 class="font-bold text-lg mb-4">Confirmar eliminación</h3>

      <!-- Texto dentro del modal -->
      <p class="mb-4">
        ¿Estás seguro que deseas eliminar la columna
        <strong>"{{ columnaAEliminarNombre }}"</strong>? Esta acción no se puede deshacer.
      </p>

      <!-- Acciones -->
      <div class="modal-action flex justify-end gap-3 mt-6">
        <button type="button" (click)="cerrarModalConfirmEliminar()" class="btn btn-outline btn-error">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary">Eliminar</button>
      </div>
    </form>
  </dialog>
  }

  <!-- Modal Nueva Etiqueta - Solo para administradores -->
  @if (puedeGestionarEtiquetas()) {
  <dialog id="modalNuevaEtiqueta"
    class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40"
    [open]="modalEtiquetaVisible">
    <form method="dialog" (submit)="crearEtiqueta($event)"
      class="modal-box max-w-md w-full p-6 bg-base-100 rounded-lg shadow-lg" autocomplete="off">
      <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <!-- Heroicon: Tag -->
        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M7 7h.01M6.618 3.076A2 2 0 0 1 8.293 2h7.413a2 2 0 0 1 1.675.923l5.386 8.462A2 2 0 0 1 22 13.615V19a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5.295a2 2 0 0 1 2.618-2.219z" />
        </svg>
        Crear Nueva Etiqueta
      </h3>

      <!-- Nombre etiqueta -->
      <label class="label">
        <span class="label-text font-semibold">Nombre *</span>
      </label>
      <input type="text" placeholder="Ej: Importante" [(ngModel)]="nuevoNombreEtiqueta" name="nombreEtiqueta"
        class="input input-bordered w-full mb-4" maxlength="50" required autofocus
        (input)="errorEtiquetaDuplicada = null" />

      <!-- Mensaje de error para duplicados -->
      @if (errorEtiquetaDuplicada){
      <div class="text-error text-xs mb-2">
        {{ errorEtiquetaDuplicada }}
      </div>
      }

      <!-- Selección de color -->
      <label class="label">
        <span class="label-text font-semibold">Color *</span>
      </label>
      <div class="flex gap-2 flex-wrap mb-4">
        @for (color of colores; track color.id) {
        <button type="button" (click)="nuevoColorEtiquetaId = color.id" [style.backgroundColor]="color.codigo"
          class="w-7 h-7 rounded-full border border-gray-400 focus:outline-none"
          [class.ring]="nuevoColorEtiquetaId === color.id" aria-label="Selecciona color {{ color.nombre }}">
          @if (nuevoColorEtiquetaId === color.id) {
          <svg class="mx-auto my-auto h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
          </svg>
          }
        </button>
        }
      </div>
      @if (!nuevoColorEtiquetaId) {
      <div class="text-error text-xs mb-2">Elige un color para la etiqueta</div>
      }

      <!-- Acciones -->
      <div class="modal-action flex justify-end gap-3 mt-6">
        <button type="button" (click)="modalEtiquetaVisible = false" class="btn btn-outline btn-error">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!nuevoNombreEtiqueta.trim() || !nuevoColorEtiquetaId">
          Crear
        </button>
      </div>
    </form>
  </dialog>
  } @if (modalEditarVisible && tareaSeleccionada) {
  <dialog id="modalEditarTarea"
    class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out z-30"
    [open]="modalEditarVisible" [ngClass]="{ 'opacity-100': modalEditarVisible, 'opacity-0': !modalEditarVisible }"
    aria-labelledby="modal-editar-title">
    <form method="dialog" (submit)="guardarCambiosTareaEditar($event)"
      class="modal-box max-w-lg w-full p-6 bg-base-100 rounded-lg shadow-xl transform transition-all duration-300 ease-in-out"
      autocomplete="off">
      <h3 id="modal-editar-title" class="font-bold text-lg mb-4 text-primary">Editar tarea</h3>

      <!-- Título -->
      <div class="mb-4">
        <label for="editTitulo" class="label font-semibold">Título *</label>
        <input id="editTitulo" type="text" placeholder="Ej: Redactar propuesta comercial"
          [(ngModel)]="tareaSeleccionada.titulo" name="editTitulo" class="input input-bordered w-full"
          [ngClass]="{ 'border-red-500': erroresEditar.titulo }" required aria-describedby="editTitulo-error" />
        @if (erroresEditar.titulo) {
        <div class="text-red-500 text-sm mt-1">El título es obligatorio</div>
        }
      </div>

      <!-- Fecha límite -->
      <div class="mb-4">
        <label for="editFechaLimite" class="label font-semibold">Fecha límite</label>
        <input id="editFechaLimite" type="date" [(ngModel)]="tareaSeleccionada.fechaLimite" name="editFechaLimite"
          class="input input-bordered w-full" />
      </div>

      <!-- Responsables -->
      <label class="label">
        <span class="label-text font-semibold">Responsables</span>
      </label>
      <div class="relative mb-4">
        <!-- Buscador -->
        <div class="mb-2">
          <input type="text" [(ngModel)]="filtroResponsables" placeholder="Buscar responsable..."
            class="input input-sm input-bordered w-full" name="filtroResponsables" />
        </div>
        <!-- Lista filtrada -->
        <ul class="max-h-40 overflow-y-auto">
          @for (miembro of miembrosFiltrados(); track miembro.usuario.id) {
          <li>
            <label>
              <input type="checkbox" [checked]="responsablesIds.includes(miembro.usuario.id)"
                (change)="selectResponsableEditar(miembro.usuario.id, $event)" />
              {{ miembro.usuario.nombre }} {{ miembro.usuario.apellido }}
            </label>
          </li>
          }
        </ul>
      </div>

      <!-- Etiquetas -->
      <div class="mb-2">
        <input type="text" [(ngModel)]="busquedaEtiqueta" placeholder="Buscar etiqueta..." name="busquedaEtiqueta"
          class="input input-sm input-bordered w-full" />
      </div>
      <ul class="max-h-40 overflow-y-auto">
        @for (etiqueta of filtrarEtiquetas(); track etiqueta.id) {
        <li>
          <label>
            <input type="checkbox" [checked]="etiquetaIds.includes(etiqueta.id)"
              (change)="selectEtiquetaEditar(etiqueta.id, $event)" />
            {{ etiqueta.nombre }}
          </label>
        </li>
        }
      </ul>

      <!-- Acciones -->
      <div class="modal-action flex justify-end gap-3 mt-6">
        <button type="button" (click)="cerrarModalEditarTarea()" class="btn btn-outline btn-error">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </dialog>
  } @if (modalGestionEtiquetasVisible) {
  <dialog id="modalGestionEtiquetas"
    class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out z-30"
    [open]="modalGestionEtiquetasVisible" [ngClass]="{
      'opacity-100': modalGestionEtiquetasVisible,
      'opacity-0': !modalGestionEtiquetasVisible
    }" aria-labelledby="modal-etiquetas-title">
    <form method="dialog"
      class="modal-box max-w-lg w-full p-6 bg-base-100 rounded-lg shadow-xl transform transition-all duration-300 ease-in-out"
      autocomplete="off">
      <!-- Título -->
      <h3 id="modal-etiquetas-title" class="font-bold text-lg mb-6 text-primary flex items-center gap-2">
        <svg class="w-7 h-7 text-teal-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke="currentColor"></circle>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h8M12 8v8" />
        </svg>
        Administrar etiquetas
      </h3>

      <!-- Buscador -->
      <div class="mb-4">
        <input type="text" [(ngModel)]="textoBusquedaEtiqueta" name="buscadorEtiqueta"
          class="input input-bordered w-full" placeholder="Buscar etiquetas por nombre..." autocomplete="off" />
      </div>

      <!-- Etiquetas con filtro y resaltador de coincidencias -->
      <div class="mb-4">
        <label class="label font-semibold">Etiquetas del proyecto</label>
        <div class="relative mb-4">
          <ul class="max-h-44 overflow-y-auto divide-y divide-gray-100">
            @for (etiqueta of etiquetasFiltradasModal; track etiqueta.id) {
            <li class="py-2">
              <label class="flex items-center gap-2">
                <input type="checkbox" class="form-checkbox h-5 w-5 accent-teal-400"
                  [checked]="etiquetasSeleccionadas.includes(etiqueta.id)"
                  (change)="toggleSeleccionEtiqueta(etiqueta.id, $event)" />
                <span class="font-medium text-base-content px-3 py-0.5 rounded"
                  [ngStyle]="{ background: etiqueta.color, color: '#fff' }"
                  style="min-width: 90px; display: inline-block"
                  [innerHTML]="highlightNombreEtiqueta(etiqueta.nombre)"></span>
              </label>
            </li>
            } @if (etiquetasFiltradasModal.length === 0) {
            <li class="py-3 text-center text-gray-400">No se encontraron etiquetas</li>
            }
          </ul>
        </div>
      </div>

      <!-- Acciones -->
      <div class="modal-action flex justify-end gap-3 mt-6">
        <button type="button" (click)="cerrarModalGestionEtiquetas()" class="btn btn-outline btn-error">
          Cancelar
        </button>
        <button type="button" class="btn btn-error" [disabled]="etiquetasSeleccionadas.length === 0"
          (click)="abrirModalConfirmarEliminarEtiquetasMultiples()">
          Eliminar seleccionadas
        </button>
      </div>
    </form>
  </dialog>
  } @if (confirmMultiDeleteActivo) {
  <dialog id="modalConfirmMultiDelete"
    class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40"
    [open]="confirmMultiDeleteActivo" aria-labelledby="modal-confirm-multi-title">
    <div class="modal-box max-w-md w-full p-7 bg-base-100 rounded-lg shadow-lg">
      <h3 id="modal-confirm-multi-title" class="font-bold text-lg mb-4 text-error">
        Confirmar eliminación múltiple
      </h3>
      <p class="mb-4">
        ¿Seguro que quieres eliminar <b>{{ etiquetasSeleccionadas.length }}</b> etiquetas
        seleccionadas? <br /><span class="text-sm text-error">Esta acción no se puede deshacer.</span>
      </p>
      <div class="flex flex-wrap gap-2 mb-4">
        @for (id of etiquetasSeleccionadas; track id) {
        <span class="badge font-semibold px-3 py-1" [ngStyle]="{ background: getColorEtiqueta(id), color: '#fff' }">
          {{ getNombreEtiqueta(id) }}
        </span>
        }
      </div>
      <div class="modal-action flex justify-end gap-3 mt-6">
        <button type="button" (click)="cerrarModalConfirmarEliminarEtiquetasMultiples()"
          class="btn btn-outline btn-error">
          Cancelar
        </button>
        <button type="button" class="btn btn-error" (click)="eliminarEtiquetasSeleccionadas()">
          Eliminar
        </button>
      </div>
    </div>
  </dialog>
  }
</div>
