// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

/////////////////////////////// CONFIG DATABASE
generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

////////////////////////////// TABLAS

model Usuario {
  id        String   @id @default(uuid()) //ID Aleatorio, para mayor seguridad.
  nombre    String
  apellido  String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  //  NUEVAS RELACIONES INVERSAS:
  tareasModificadas Tarea[]       @relation("LastModifiedBy") // Tareas donde es el 煤ltimo modificador
  tareasEditadas    TareaEditor[] // Tareas que ha editado alguna vez

  // Relaciones: Un usuario puede...
  // ...crear muchos proyectos.
  proyectosCreados Proyectos[]    @relation("ProyectosCreados")
  // ...ser miembro en diferentes proyectos (a trav茅s de la tabla Miembro).
  miembroDe        Miembro[]
  // ...ser responsable de varias tareas (a trav茅s de la tabla Responsable).
  responsableDe    Responsable[]
  // ...escribir muchos comentarios.
  comentarios      Comentario[]
  // ...recibir muchas notificaciones.
  notificaciones   Notificacion[]

  @@schema("public")
}

//Trazabilidad de Editores de Contenido
model TareaEditor {
  id        Int      @id @default(autoincrement())
  
  tareaId   String
  tarea     Tarea    @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  
  usuarioId String
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  
  @@unique([tareaId, usuarioId]) // Un usuario solo puede estar una vez en la lista de editores de una tarea
  @@schema("public")
}

// Modelo para los proyectos.
model Proyectos {
  id          String   @id @default(uuid())
  nombre      String
  descripcion String?
  createdAt   DateTime @default(now())

  // Relaci贸n con el usuario que cre贸 el proyecto.
  creadoPor   Usuario @relation("ProyectosCreados", fields: [creadoPorId], references: [id])
  creadoPorId String

  // Relaciones: Un proyecto puede tener...
  // ...muchos miembros.
  miembros Miembro[]
  // ...varios estados o columnas en el tablero (To Do, Doing, Done).
  estados  Estado[] /// ID de 
  // ...muchas tareas.
  tareas   Tarea[]

  etiquetas     Etiqueta[] // Cada etiqueta pertenece a un unico proyecto / Cada proyecto puede tener muchas etiquetas
  notificacions Notificacion[]

  @@schema("public")
}

// Modelo para las tareas dentro de un proyecto.
model Tarea {
  id          String    @id @default(uuid())
  titulo      String?   @db.VarChar(255)
  fechaLimite DateTime? @db.Date
  // Posici贸n de la tarea dentro de una columna/estado.
  posicion    Int       @default(0)
  createdAt   DateTime  @default(now())

  //Campos para la trazabilidad en Editor de texto
  lastModifiedAt   DateTime  @updatedAt @default(now()) // Se actualiza autom谩ticamente en cada 'update'
  lastModifiedById String?   // ID del 煤ltimo usuario que guard贸 el contenido
  lastModifiedBy   Usuario?  @relation("LastModifiedBy", fields: [lastModifiedById], references: [id])
  editores         TareaEditor[]

  // Relaci贸n con el proyecto al que pertenece.
  proyecto   Proyectos @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId String
  // Relaci贸n con el estado actual de la tarea.
  estado     Estado    @relation(fields: [estadoId], references: [id], onDelete: Restrict)
  estadoId   Int

  // Relaciones: Una tarea puede tener...
  // ...varios usuarios responsables.
  responsables   Responsable[]
  // ...muchos comentarios.
  comentarios    Comentario[]
  // ...muchas notificaciones asociadas.
  notificaciones Notificacion[]
  // ...varias etiquetas (a trav茅s de la tabla de uni贸n TareasEtiquetas).
  etiquetas      TareasEtiquetas[]

  BloqueContenido BloqueContenido[]

  @@schema("public")
}

/////// BLOQUE MANIPULA EL ORDEN DE COMPONENTES DENTRO DE UNA TAREA > ej: un titulo no especificamente debe de aparecer de los primeros, se podria mover al final de la desc de la tarea
model BloqueContenido {
  id      String @id @default(uuid())
  // A qu茅 tarea pertenece este bloque
  tarea   Tarea  @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId String

  // El tipo de bloque que es
  // Ej: "heading1", "paragraph", "checklist", "code", "image"
  tipo      TipoDeBloque
  // El contenido real del bloque (texto, URL de la imagen, etc.)
  contenido String       @db.Text
  // Para mantener el orden de los bloques dentro de la tarea
  posicion  Int

  @@index([tareaId, posicion]) // Indexar por tarea y posici贸n para una carga r谩pida
  @@schema("public")
}

// Define los 煤nicos valores permitidos para el tipo de bloque
enum TipoDeBloque {
  PARAGRAPH
  HEADING_1
  HEADING_2
  CHECKLIST
  IMAGE
  CODE

  @@schema("public")
}

// --- MODELOS DE RELACIN Y SOPORTE ---

// Roles que un usuario puede tener en un proyecto (ej: Admin, Miembro).
model Roles {
  id     Int    @id @default(autoincrement())
  nombre String @unique @db.VarChar(50)

  // Relaci贸n: Un rol puede ser asignado a muchos miembros.
  miembros Miembro[]

  @@schema("public")
}

// Tabla pivote para la relaci贸n muchos-a-muchos entre Usuario y Proyectos.
// Define qu茅 rol tiene cada usuario en cada proyecto.
model Miembro {
  id Int @id @default(autoincrement())

  // Relaciones expl铆citas.
  usuario    Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId  String
  proyecto   Proyectos @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId String
  rol        Roles     @relation(fields: [rolId], references: [id], onDelete: Restrict)
  rolId      Int

  // Un usuario solo puede ser miembro de un proyecto una vez.
  @@unique([usuarioId, proyectoId])
  @@schema("public")
}

// Define los estados o columnas del tablero Kanban para un proyecto.
model Estado {
  id       Int    @id @default(autoincrement())
  nombre   String @db.VarChar(50)
  // Posici贸n de la columna en el tablero.
  posicion Int /// POSICIN EN EL ARRAY

  // Relaci贸n con el proyecto al que pertenece el estado.
  proyecto   Proyectos @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId String

  colorId Int // Relaci贸n con tabla Color
  color   Color @relation(fields: [colorId], references: [id])

  // Relaci贸n: Un estado puede contener muchas tareas.
  tareas Tarea[]

  @@unique([nombre, proyectoId], map: "nombre_proyectoId")
  @@schema("public")
}

// Tabla pivote para asignar responsables (usuarios) a las tareas.
model Responsable {
  id Int @id @default(autoincrement())

  // Relaciones expl铆citas.
  tarea     Tarea   @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId   String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId String

  // Un usuario solo puede ser asignado una vez a la misma tarea.
  @@unique([tareaId, usuarioId])
  @@schema("public")
}

// Modelo para los comentarios en las tareas.
model Comentario {
  id        Int      @id @default(autoincrement())
  contenido String   @db.Text
  createdAt DateTime @default(now())

  // Relaci贸n con la tarea comentada.
  tarea     Tarea   @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId   String
  // Relaci贸n con el autor del comentario.
  autor     Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId String

  @@schema("public")
}

// Modelo para las notificaciones de los usuarios.        --> Solo en las que se menciona al usuario
model Notificacion {
  id        String   @id @default(uuid())
  tipo      String // 'tarea_creada', 'tarea_editada', 'tarea_eliminada', 'tarea_por_vencer'
  mensaje   String
  leida     Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relaci贸n con el usuario que recibe la notificaci贸n
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId String

  // Relaci贸n con la tarea
  tarea   Tarea?  @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId String?

  // Relaci贸n con el proyecto
  proyecto   Proyectos @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId String

  @@schema("public")
}

// Modelo para las etiquetas que se pueden asignar a las tareas.              --> Lista de etiquetas
model Etiqueta {
  id     Int    @id @default(autoincrement())
  nombre String @db.VarChar(50)

  // Relaci贸n con el color de la etiqueta
  colorId Int // Relaci贸n con el color de la etiqueta
  color   Color @relation(fields: [colorId], references: [id]) // Relaci贸n con la tabla Color

  // Nueva relaci贸n directa con el proyecto al que pertenece la etiqueta
  proyecto   Proyectos @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId String

  // Relaci贸n con tareas a trav茅s de la tabla pivote // Relaci贸n: Una etiqueta puede estar en muchas tareas.
  tareas TareasEtiquetas[]

  // Regla: un mismo nombre puede repetirse en distintos proyectos,
  // pero debe ser 煤nico dentro de un mismo proyecto
  @@unique([nombre, proyectoId])
  @@schema("public")
}

// Tabla pivote para la relaci贸n muchos-a-muchos entre Tarea y Etiqueta.      --> Asignaci贸n de etiquetas dentro de una tarea
model TareasEtiquetas {
  // Relaciones expl铆citas que forman la clave primaria compuesta.
  tarea      Tarea    @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId    String
  etiqueta   Etiqueta @relation(fields: [etiquetaId], references: [id], onDelete: Cascade)
  etiquetaId Int

  @@id([tareaId, etiquetaId])
  @@schema("public")
}

model Color {
  id     Int    @id @default(autoincrement())
  nombre String @db.VarChar(50) // Nombre del color (por ejemplo, "Rojo", "Verde", etc.)
  codigo String @db.VarChar(7) // C贸digo hexadecimal del color (p.ej., #f59e0b para rojo)

  // Relaci贸n de colores con etiquetas
  etiquetas Etiqueta[] // Relaci贸n con las etiquetas

  Estado Estado[]

  @@schema("public")
}
