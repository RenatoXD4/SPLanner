// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init


/////////////////////////////// CONFIG DATABASE
generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas = ["public"]
}

////////////////////////////// TABLAS

model Usuario {
  id        String @id @default(uuid()) //ID Aleatorio, para mayor seguridad.
  nombre    String
  apellido  String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  // Relaciones: Un usuario puede...
  // ...crear muchos proyectos.
  proyectosCreados Proyectos[] @relation("ProyectosCreados")
  // ...ser miembro en diferentes proyectos (a través de la tabla Miembro).
  miembroDe        Miembro[]
  // ...ser responsable de varias tareas (a través de la tabla Responsable).
  responsableDe    Responsable[]
  // ...escribir muchos comentarios.
  comentarios      Comentario[]
  // ...recibir muchas notificaciones.
  notificaciones   Notificacion[]

  @@schema("public")
}

// Modelo para los proyectos.
model Proyectos {
  id          String   @id @default(uuid())
  nombre      String
  descripcion String?
  createdAt   DateTime @default(now())

  // Relación con el usuario que creó el proyecto.
  creadoPor   Usuario @relation("ProyectosCreados", fields: [creadoPorId], references: [id])
  creadoPorId String

  // Relaciones: Un proyecto puede tener...
  // ...muchos miembros.
  miembros Miembro[]
  // ...varios estados o columnas en el tablero (To Do, Doing, Done).
  estados  Estado[]       /// ID de 
  // ...muchas tareas.
  tareas   Tarea[]
  @@schema("public")
}

// Modelo para las tareas dentro de un proyecto.
model Tarea {
  id              String       @id @default(uuid())
  titulo          String?    @db.VarChar(255)
  fechaLimite     DateTime? @db.Date
  // Posición de la tarea dentro de una columna/estado.
  posicion        Int       @default(0)
  createdAt       DateTime  @default(now())

  // Relación con el proyecto al que pertenece.
  proyecto    Proyectos @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId  String
  // Relación con el estado actual de la tarea.
  estado      Estado @relation(fields: [estadoId], references: [id], onDelete: Restrict)
  estadoId    Int

  // Relaciones: Una tarea puede tener...
  // ...varios usuarios responsables.
  responsables   Responsable[]
  // ...muchos comentarios.
  comentarios    Comentario[]
  // ...muchas notificaciones asociadas.
  notificaciones Notificacion[]
  // ...varias etiquetas (a través de la tabla de unión TareasEtiquetas).
  etiquetas      TareasEtiquetas[]

  BloqueContenido BloqueContenido[]
  @@schema("public")
}

/////// BLOQUE MANIPULA EL ORDEN DE COMPONENTES DENTRO DE UNA TAREA > ej: un titulo no especificamente debe de aparecer de los primeros, se podria mover al final de la desc de la tarea
model BloqueContenido {
  id        String   @id @default(uuid())
  // A qué tarea pertenece este bloque
  tarea     Tarea    @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId   String

  // El tipo de bloque que es
  // Ej: "heading1", "paragraph", "checklist", "code", "image"
  tipo      TipoDeBloque
  // El contenido real del bloque (texto, URL de la imagen, etc.)
  contenido String   @db.Text
  // Para mantener el orden de los bloques dentro de la tarea
  posicion  Int

  @@index([tareaId, posicion]) // Indexar por tarea y posición para una carga rápida
  @@schema("public")
}


// Define los únicos valores permitidos para el tipo de bloque
enum TipoDeBloque {
  PARAGRAPH
  HEADING_1
  HEADING_2
  CHECKLIST
  IMAGE
  CODE
  @@schema("public")
}
// --- MODELOS DE RELACIÓN Y SOPORTE ---

// Roles que un usuario puede tener en un proyecto (ej: Admin, Miembro).
model Roles {
  id     Int    @id @default(autoincrement())
  nombre String @unique @db.VarChar(50)

  // Relación: Un rol puede ser asignado a muchos miembros.
  miembros Miembro[]
  @@schema("public")
}

// Tabla pivote para la relación muchos-a-muchos entre Usuario y Proyectos.
// Define qué rol tiene cada usuario en cada proyecto.
model Miembro {
  id Int @id @default(autoincrement())

  // Relaciones explícitas.
  usuario    Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)     
  usuarioId  String                                                                             
  proyecto   Proyectos @relation(fields: [proyectoId], references: [id], onDelete: Cascade)     
  proyectoId String
  rol        Roles @relation(fields: [rolId], references: [id], onDelete: Restrict)
  rolId      Int

  // Un usuario solo puede ser miembro de un proyecto una vez.
  @@unique([usuarioId, proyectoId])
  @@schema("public")
}

// Define los estados o columnas del tablero Kanban para un proyecto.
model Estado {
  id        Int    @id @default(autoincrement())
  nombre    String @db.VarChar(50)
  // Posición de la columna en el tablero.
  posicion  Int       /// POSICIÓN EN EL ARRAY

  // Relación con el proyecto al que pertenece el estado.
  proyecto   Proyectos @relation(fields: [proyectoId], references: [id], onDelete: Cascade)
  proyectoId String

  // Relación: Un estado puede contener muchas tareas.
  tareas Tarea[]
  @@schema("public")
}

// Tabla pivote para asignar responsables (usuarios) a las tareas.
model Responsable {
  id Int @id @default(autoincrement())

  // Relaciones explícitas.
  tarea     Tarea   @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId   String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId String

  // Un usuario solo puede ser asignado una vez a la misma tarea.
  @@unique([tareaId, usuarioId])
  @@schema("public")
}

// Modelo para los comentarios en las tareas.
model Comentario {
  id        Int      @id @default(autoincrement())
  contenido String   @db.Text
  createdAt DateTime @default(now())

  // Relación con la tarea comentada.
  tarea     Tarea   @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId   String
  // Relación con el autor del comentario.
  autor     Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId String
  @@schema("public")
}

// Modelo para las notificaciones de los usuarios.        --> Solo en las que se menciona al usuario
model Notificacion {
  id        Int      @id @default(autoincrement())
  // Tipo de notificación: 'comentario', 'asignacion', 'cambio_estado', etc.
  tipo      String   @db.VarChar(50)
  mensaje   String   @db.Text
  leida     Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relación con el usuario que recibe la notificación.
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  usuarioId String
  // Relación opcional con una tarea.
  tarea     Tarea?  @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId   String?
  @@schema("public")
}

// Modelo para las etiquetas que se pueden asignar a las tareas.              --> Lista de etiquetas
model Etiqueta {
  id     Int    @id @default(autoincrement())
  nombre String @unique @db.VarChar(50)

  // Relación: Una etiqueta puede estar en muchas tareas.
  tareas TareasEtiquetas[]
  @@schema("public")
}

// Tabla pivote para la relación muchos-a-muchos entre Tarea y Etiqueta.      --> Asignación de etiquetas dentro de una tarea
model TareasEtiquetas {
  
  // Relaciones explícitas que forman la clave primaria compuesta.
  tarea     Tarea    @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  tareaId   String
  etiqueta  Etiqueta @relation(fields: [etiquetaId], references: [id], onDelete: Cascade)
  etiquetaId Int

  @@id([tareaId, etiquetaId])
  @@schema("public")

}



